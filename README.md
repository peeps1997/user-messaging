<p align="center">
  <a href="http://youkraft.com/" target="blank"><img src="https://www.youkraft.com/static/media/YoukraftLogo.948e539c.svg" width="200" alt="Nest Logo" /></a>
</p>

[circleci-image]: https://img.shields.io/circleci/build/github/nestjs/nest/master?token=abc123def456
[circleci-url]: https://circleci.com/gh/nestjs/nest

  <p align="center">A Messaging ReST APP</p>
    <p align="center">

## Description

A Test App in NestJS 

## Installation

```bash
$ npm install
  
# RabbitMQ installation 
$ brew update
$ brew install rabbitmq
$ export PATH=$PATH:/usr/local/sbin
$ brew services start rabbitmq
```

## Running the app

```bash
# development
$ npm run start

# watch mode
$ npm run start:dev
  
```

## Working

This Test Messaging App has the following Collections/Data Model - 
```bash
+-- user
|   +-- id # Manually input ID - (If not present, then autogenerated one)
|   +-- email # User email
|   +-- password # User Password - we\'re storing the sha256 hash of the password.

+-- messages
|   +-- id # AutoGen ID
|   +-- text # User input text of the txn
|   +-- timestamp #  Epoch Timestamp of the message
|   +-- isSent # bool flag if message has been saved
|   +-- fromUser # User Many to One relation. points to the User ID of the Sender
|   +-- toUser # User Many to One relation. points to the User ID of the Recipient.
```

This Test App has the following public endpoints  - 
```bash
+-- "/auth/login" #To login an already existing user
+-- "/users/create" #To create a user
+-- "/users/" #To Get all users. This shouldnt be public but for test purposes we can make the adjustments
```

and following protected endpoints (using an access token in the header will grant us access to these resources based on logged in user) - 
```bash
+-- "/users/:id" #To view the user with 'id'
+-- "/users/:email" #To view the user with 'email'
+-- "/users/:id/create-message" #To create a message for the user with 'id'. 
+-- "/users/:id/get-message" #To get all messages received by the user with 'id'
+-- "/users/:id/sent-message" #To get all messages sent by the user with 'id'
```

### [POST] Create a user

To use the app, start my creating a user. (You can use postman to hit the endpoints)


#### Endpoint - 
```bash
'/users/create'
```

#### Request Body -

```bash
{
    "id":<Your id/ Autogenerated ID>, #optional
    "email": <Email>,
    "password": <Password>
}
```

#### Sample Request - 

```bash
curl --location --request POST 'http://127.0.0.1:3000/users/create' \
--header 'Content-Type: application/json' \
--data-raw '{
    "id":1,
    "email":"rev@gmail.com",
    "password":"abcd1234"
}'
```

#### Response

This endpoint returns the user object that was saved into the DB. Note how the password is saved as the hash of the content 'abcd1234' we sent in.

###### NOTE:- For security purposes we shouldn't send the password in the response object.

```bash
{
    "id": 1232,
    "email": "rev@gmail.com",
    "password": "7d70a26b834d9881cc14466eceac8d39188fc5ef5ffad9ab281a8327c2c0d093"
}
```

### [POST] Login user 

Login a user. (You can use postman to hit the endpoints)

#### Endpoint - 

```bash
'/auth/login'
```

#### Request Body -

```bash
{"username": <Email>, "password": <Password>}
```

#### Sample Request - 

```bash
curl --location --request POST 'http://127.0.0.1:3000/auth/login' \
--header 'Content-Type: application/json' \
--data-raw '{"username": "jay@gmail.com", "password": "abcd1234"}'
```

#### Response

This endpoint returns the access token that will be used for accessing protected endpoints. Note how the token is a jwt token which will be decoded in subsequent requests to validate the user. The token has a TTL configuration for \"10000s\".

```bash
{
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImpheUBnbWFpbC5jb20iLCJpZCI6MTMyLCJpYXQiOjE2Njg4NTcyMzAsImV4cCI6MTY2ODg2NzIzMH0.2_-3m5xc7yBToF0ZYRHng4YCVIgSj8v_L-s1YHyzznc"
}
```

#### Now that we have the access_token, we can use the Protected Endpoints-
#### We have to send the access_token in the Authorization header of all requests

## User Endpoints

### [GET] View a user with id

Returns object of the logged in user. (You can use postman to hit the endpoints)

#### Endpoint - 

```bash
'/users/:id' 
```

#### Request Param -

```bash
id #Id of the user we want to retrieve
```

#### Sample Request - 

```bash
curl --location --request GET 'http://127.0.0.1:3000/users/132' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImpheUBnbWFpbC5jb20iLCJpZCI6MTMyLCJpYXQiOjE2Njg4NTcyMzAsImV4cCI6MTY2ODg2NzIzMH0.2_-3m5xc7yBToF0ZYRHng4YCVIgSj8v_L-s1YHyzznc' \
```

#### Response

Sends us the User Object

```bash
{
    "id": 132,
    "email": "jay@gmail.com",
    "password": "7d70a26b834d9881cc14466eceac8d39188fc5ef5ffad9ab281a8327c2c0d093"
}
```

### [GET] View a user with email

Reeturns object of the logged in user. (You can use postman to hit the endpoints)

#### Endpoint - 

```bash
'/users/:email' 
```

#### Request Param -

```bash
email #email of the user we want to retrieve
```

#### Sample Request - 

```bash
curl --location --request GET 'http://127.0.0.1:3000/users/jay@gmail.com' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImpheUBnbWFpbC5jb20iLCJpZCI6MTMyLCJpYXQiOjE2Njg4NTcyMzAsImV4cCI6MTY2ODg2NzIzMH0.2_-3m5xc7yBToF0ZYRHng4YCVIgSj8v_L-s1YHyzznc' \
```

#### Response

Sends us the User Object

```bash
{
    "id": 132,
    "email": "jay@gmail.com",
    "password": "7d70a26b834d9881cc14466eceac8d39188fc5ef5ffad9ab281a8327c2c0d093"
}
```

### [POST] Create a message

Returns an an express Response Object. (You can use postman to hit the endpoints)

#### Endpoint - 

```bash
'/users/:id/create-message'
```

#### Request Param -

```bash
id #id of the user we want to update
```

#### Request Body (optional) -

```bash
{   
    "text":"Hello this is a test message from dufy",
    "isSent":"false", #Optional, force set to false when adding to queue
    "fromUser":{ "id":<id of sender>}, #Optional, will be picked up from param id if not provided
    "toUser":{ "id":<id of recipient> } #Required, otherwise message will be discarded.
}
```

#### Sample Request - 

```bash
curl --location --request GET 'http://127.0.0.1:3000/users/1/create-message' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImFiY0BnbWFpbC5jb20iLCJpZCI6MSwiaWF0IjoxNjY5NTkzNjY5LCJleHAiOjE2Njk2MDM2Njl9.i7pG7N2OaLD42LI5MbGEpo1wJYTLz6j39q8mVZ5TMsI' \
--header 'Content-Type: application/json' \
--data-raw '{   
    "text":"Hello this is a test message from dufy",
    "isSent":"false",
    "toUser":{
        "id":1
    }
    }'
```

#### Response

Response has deliveryStatus field.

```bash
{
    "deliveryStatus": "success"
}
```

### [GET] Get all messages

Get all messages from the user with 'id'

#### Endpoint - 

```bash
'/users/:id/get-message'
```

#### Request Param -

```bash
id #id of the user
```

#### Sample Request - 

```bash
curl --location --request GET 'http://127.0.0.1:3000/users/1/get-message' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImFiY0BnbWFpbC5jb20iLCJpZCI6MSwiaWF0IjoxNjY5NTkzNjY5LCJleHAiOjE2Njk2MDM2Njl9.i7pG7N2OaLD42LI5MbGEpo1wJYTLz6j39q8mVZ5TMsI'
```

#### Response


```bash
[
    {
        "id": 6,
        "text": "Hello this is a test message from dufy",
        "timestamp": "1669592653000",
        "isSent": true
    },
    {
        "id": 9,
        "text": "Hello this is a test message from dufy",
        "timestamp": "1669594252000",
        "isSent": true
    }
]
```


### [GET] Get all messages SENT by a user

Get all messages SENT by the user with 'id'

#### Endpoint - 

```bash
'/users/:id/sent-message'
```

#### Request Param -

```bash
id #id of the user
```

#### Sample Request - 

```bash
curl --location --request GET 'http://127.0.0.1:3000/users/1/sent-message' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImFiY0BnbWFpbC5jb20iLCJpZCI6MSwiaWF0IjoxNjY5NTkzNjY5LCJleHAiOjE2Njk2MDM2Njl9.i7pG7N2OaLD42LI5MbGEpo1wJYTLz6j39q8mVZ5TMsI'
```

#### Response


```bash
[
    {
        "id": 1,
        "text": "Hello this is a test message SECONDARY",
        "timestamp": 1669594252000,
        "isSent": true
    },
    {
        "id": 2,
        "text": "Hello this is a test message SECONDARY",
        "timestamp": 1669594252000,
        "isSent": true
    }
]
```

## Error Handling

Following Error Codes are incorporated and you might encounter them due to following reasons-
```bash
401-Unauthorized #user unauthorized
403-Forbidden #resource that is being accessed does not belong to that user
500-Internal Server Error #request caused an error in the system which has been caught.
```
